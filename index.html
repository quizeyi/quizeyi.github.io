<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quizeyi - AI Quiz Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* =============================================
         * Design System & Theming
         * ============================================= */
        :root {
            --bg-light: #f2f2f7; --text-light: #000000; --card-light: #ffffff; --border-light: #e5e5ea;
            --header-light: rgba(249, 249, 249, 0.85); --text-secondary-light: #3c3c4399;
            
            --bg-dark: #000000; --text-dark: #ffffff; --card-dark: #1c1c1e; --border-dark: #38383a;
            --header-dark: rgba(28, 28, 30, 0.85); --text-secondary-dark: #ebebf599;

            --accent-blue: #0a84ff; --accent-green: #30d158; --accent-red: #ff453a; --accent-yellow: #ffc600;
            --accent-purple: #bf5af2; --accent-indigo: #5e5ce6;
        }
        
        /* =============================================
         * Base & Global Styles
         * ============================================= */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-dark); /* Default to dark theme */
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior-y: none;
            -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;
        }
        html.dark body { background-color: var(--bg-dark); color: var(--text-dark); }
        html.light body { background-color: var(--bg-light); color: var(--text-light); }
        
        .text-secondary { color: var(--text-secondary-light); }
        html.dark .text-secondary { color: var(--text-secondary-dark); }
        html.light .text-secondary { color: var(--text-secondary-light); }

        .content-transition { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* =============================================
         * Component Styles: Header, Cards, Panels
         * ============================================= */
        .ios-header { background-color: var(--header-light); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-light); transition: background-color 0.3s ease, border-color 0.3s ease; }
        html.dark .ios-header { background-color: var(--header-dark); border-bottom-color: var(--border-dark); }
        html.light .ios-header { background-color: var(--header-light); border-bottom-color: var(--border-light); }

        .ios-card { background-color: var(--card-light); transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease; }
        html.dark .ios-card { background-color: var(--card-dark); }
        html.light .ios-card { background-color: var(--card-light); }
        
        .ios-panel { background-color: var(--card-light); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.3s ease; touch-action: none; }
        html.dark .ios-panel { background-color: var(--card-dark); }
        html.light .ios-panel { background-color: var(--card-light); }
        .ios-panel.active { transform: translateY(0); }
        
        /* Search Input Styling */
        #search-input {
            width: 0;
            padding-left: 0;
            padding-right: 0;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        #search-wrapper.is-active #search-input {
            width: 150px; /* Adjust width as needed */
            opacity: 1;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        @media (min-width: 640px) {
            #search-wrapper.is-active #search-input { width: 250px; }
        }


        /* =============================================
         * Animations & Effects
         * ============================================= */
        .gradient-text { background: linear-gradient(90deg, var(--accent-blue), var(--accent-indigo), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 6s ease infinite; background-size: 200% 200%; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .blinking-row { animation: blink-animation 1.8s ease-in-out infinite; }
        @keyframes blink-animation { 0%, 100% { background-color: transparent; } 50% { background-color: #0a84ff22; } }
        html.dark .blinking-row { animation: blink-animation-dark 1.8s ease-in-out infinite; }
        @keyframes blink-animation-dark { 0%, 100% { background-color: transparent; } 50% { background-color: #0a84ff33; } }
        
        .modal-container { transition: opacity 0.25s ease; }
        .modal-box { transition: transform 0.25s ease, opacity 0.25s ease; transform: scale(0.95); opacity: 0; }
        .modal-container.opacity-100 .modal-box { transform: scale(1); opacity: 1; }

        #donation-button { background-color: var(--accent-red); animation: pulse-animation 2s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        @keyframes pulse-animation { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 58, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 69, 58, 0); } }
        .ad-container { position: absolute; height: 1px; width: 1px; top: -10px; left: -10px; visibility: hidden; pointer-events: none; z-index: -1; }
    </style>
</head>
<body class="antialiased">



<script type="text/javascript"> atOptions = { 'key' : 'ade27afee177c088e865bebbc4dca698', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} }; </script> <script type="text/javascript" src="//www.highperformanceformat.com/ade27afee177c088e865bebbc4dca698/invoke.js"></script>







    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black transition-opacity duration-500 p-8 text-center">
        <div class="flex-grow flex items-center justify-center">
             <div id="lottie-animation" class="w-108 h-108"></div>
        </div>
        <div class="flex-shrink-0 mb-8">
             <h1 class="text-4xl font-bold gradient-text">Quizeyi</h1>
             <p class="text-gray-400 mt-2"></p>
        </div>
    </div>

    <!-- AdBlock Warning -->
    <div id="adblock-warning" class="hidden fixed inset-0 z-[120] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-red-600 text-white p-8 rounded-2xl shadow-lg max-w-sm text-center">
            <svg class="w-16 h-16 mx-auto text-red-200 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <h2 class="text-2xl font-bold mb-2">Ad Blocker Detected</h2>
            <p class="text-red-100">To ensure full functionality, please disable your ad blocker for this site and refresh the page.</p>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app" class="hidden opacity-0 transition-opacity duration-300">
        <header id="main-header" class="ios-header sticky top-0 z-30 w-full"><div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-16"><div id="header-left-content" class="flex-1 flex items-center min-w-0 transition-opacity duration-300"><button id="back-button" aria-label="Go back" class="hidden -ml-2 p-2 text-[color:var(--accent-blue)] flex items-center gap-1 group"><svg class="w-6 h-6 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg><span id="back-button-text" class="text-lg font-medium">Back</span></button><h1 id="header-title" class="text-3xl font-bold truncate">Dashboard</h1></div><div class="flex items-center gap-2"><div id="search-wrapper" class="relative flex items-center"><input type="search" id="search-input" placeholder="Search..." class="bg-gray-200 dark:bg-gray-800 rounded-full py-1.5 border-0 focus:ring-2 focus:ring-[color:var(--accent-blue)]"><button id="search-button" aria-label="Search" class="p-2 rounded-full text-[color:var(--accent-blue)]"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button></div><button id="settings-button" aria-label="Open settings" class="p-2 rounded-full text-[color:var(--accent-blue)] relative"><span id="notification-badge" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-[color:var(--accent-red)] rounded-full border-2 border-[color:var(--card-light)] dark:border-[color:var(--card-dark)]"></span><svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div></div></div></header>
        
        <div id="ad-placeholder-top" class="flex justify-center py-2"></div>

        <main id="main-content" class="max-w-5xl mx-auto p-4 sm:px-6 lg:px-8"></main>

        <div id="ad-placeholder-bottom" class="flex justify-center py-4"></div>
        
        <div id="donation-container" class="fixed bottom-5 right-5 z-40 cursor-grab active:cursor-grabbing flex items-center gap-3">
            <div id="donation-message" class="px-3 py-1.5 text-sm bg-gray-900/80 dark:bg-gray-200/80 text-white dark:text-black rounded-lg shadow-lg backdrop-blur-sm whitespace-nowrap pointer-events-none transition-opacity duration-300"></div>
            <a id="donation-link" href="upi://pay?pa=ali.192@superyes&pn=Donation for Quizeyi">
                <div id="donation-button" class="p-3 rounded-full shadow-lg text-white"><svg class="w-8 h-8 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg></div>
            </a>
        </div>
    </div>
    
    <div id="panel-overlay" class="fixed inset-0 bg-black/40 z-40 opacity-0 hidden transition-opacity duration-300" aria-hidden="true"></div>
    
    <div id="settings-panel" class="ios-panel fixed bottom-0 left-0 right-0 z-50 rounded-t-2xl p-4 shadow-2xl max-h-[90vh] overflow-y-auto"><div class="w-10 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-6"></div><div class="space-y-4">
        <div class="ios-card rounded-xl p-4"><p class="font-medium mb-3">Theme</p><div class="flex space-x-2 bg-gray-200 dark:bg-gray-800 p-1 rounded-lg"><button data-theme="light" class="theme-btn flex-1 p-2 rounded-md font-semibold">Light</button><button data-theme="dark" class="theme-btn flex-1 p-2 rounded-md font-semibold">Dark</button><button data-theme="system" class="theme-btn flex-1 p-2 rounded-md font-semibold">System</button></div></div>
        <div class="ios-card rounded-xl"><div id="notifications-button" role="button" class="flex items-center justify-between p-4 w-full cursor-pointer"><span class="font-medium">Notifications</span><div class="flex items-center gap-2"><svg class="w-5 h-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></div></div></div>
        <div class="ios-card rounded-xl p-4"><p class="font-medium mb-3">Language</p><div class="flex space-x-2 bg-gray-200 dark:bg-gray-800 p-1 rounded-lg"><button data-lang="en" class="lang-btn flex-1 p-2 rounded-md font-semibold">English</button><button data-lang="hi" class="lang-btn flex-1 p-2 rounded-md font-semibold">हिंदी</button></div></div>
        <div class="ios-card rounded-xl"><div id="clear-attempts-btn" role="button" class="flex items-center justify-between p-4 w-full cursor-pointer text-[color:var(--accent-red)]"><span class="font-medium">Clear Quiz Attempts</span><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div></div>
        <div class="ios-card divide-y divide-[color:var(--border-light)] dark:divide-[color:var(--border-dark)] rounded-xl"><a href="https://t.me/Mineauge1" target="_blank" class="flex items-center justify-between p-4 w-full text-left text-[color:var(--accent-blue)]"><span class="font-medium">Contact Admin</span><svg class="w-5 h-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a><a href="https://t.me/ourResulti" target="_blank" class="flex items-center justify-between p-4 w-full text-left text-[color:var(--accent-blue)]"><span class="font-medium">Result Group</span><svg class="w-5 h-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></div>
        <div class="ios-card p-1 rounded-xl"><input type="text" id="admin-code-input" class="w-full bg-transparent border-0 text-center focus:ring-0 placeholder-gray-400 dark:placeholder-gray-600" placeholder="Admin Code"></div>
    </div></div>

    <div id="notifications-panel" class="ios-panel fixed bottom-0 left-0 right-0 z-[60] rounded-t-2xl p-4 shadow-2xl max-h-[90vh] overflow-y-auto"><div class="w-10 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-6"></div><h2 class="text-2xl font-bold text-center mb-4">Notifications</h2><div id="notifications-list" class="space-y-3"></div></div>
    <div id="admin-panel-container" class="hidden fixed inset-0 z-50 bg-black/30 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
    <div id="form-modal" class="modal-container hidden fixed inset-0 z-[70] flex items-center justify-center p-4"><div class="modal-box ios-card w-full max-w-lg p-6 rounded-2xl shadow-lg relative"><button id="close-modal-btn" aria-label="Close modal" class="absolute top-2 right-2 p-2 rounded-full text-secondary"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 id="modal-title" class="text-xl font-bold text-center mb-6">Modal Title</h2><form id="modal-form" class="space-y-4"></form></div></div>
    <div id="confirm-modal" class="modal-container hidden fixed inset-0 z-[80] flex items-center justify-center p-4"><div class="modal-box ios-card w-full max-w-sm p-6 rounded-2xl shadow-lg text-center"><h2 id="confirm-modal-title" class="text-xl font-bold mb-2">Are you sure?</h2><p id="confirm-modal-text" class="text-secondary mb-6">This action cannot be undone.</p><div class="flex gap-3"><button id="confirm-cancel-btn" class="w-full p-3 bg-gray-200 dark:bg-gray-800 rounded-lg font-semibold transition hover:bg-gray-300 dark:hover:bg-gray-700">Cancel</button><button id="confirm-action-btn" class="w-full p-3 bg-[color:var(--accent-red)] text-white rounded-lg font-semibold transition hover:opacity-90">Confirm</button></div></div></div>
    <div id="toast" class="fixed bottom-[-100px] left-1/2 -translate-x-1/2 bg-gray-900/80 dark:bg-gray-200/80 text-white dark:text-black px-4 py-2 rounded-lg shadow-lg transition-all duration-300 backdrop-blur-sm z-[100]"><p id="toast-message" class="font-medium"></p></div>
    
    <div id="terms-modal" class="hidden fixed inset-0 z-[110] bg-black/40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="ios-card w-full max-w-md p-6 rounded-2xl shadow-lg flex flex-col max-h-[80vh]">
            <h2 class="text-2xl font-bold text-center mb-4 flex-shrink-0">Terms and Conditions</h2>
            <div class="text-sm text-secondary space-y-4 overflow-y-auto pr-2">
                <p><strong id="effective-date"></strong></p>
                <p>Welcome to Quizeyi. By using this website, you agree to the following terms:</p>
                <h3 class="font-semibold text-base text-black dark:text-white mb-1">1. Use of Website:</h3><ul class="list-disc list-inside space-y-1"><li>For educational purposes only. Do not manipulate or hack the system.</li></ul>
                <h3 class="font-semibold text-base text-black dark:text-white mb-1 mt-2">2. AI-Generated Content:</h3><ul class="list-disc list-inside space-y-1"><li>Quizzes are AI-generated for practice. Verify information if necessary.</li></ul>
                <h3 class="font-semibold text-base text-black dark:text-white mb-1 mt-2">3. Data & Results:</h3><ul class="list-disc list-inside space-y-1"><li>Basic information may be collected to track results.</li><li>By using Quizeyi, you consent to your results being shared in designated Telegram groups.</li></ul>
                <div id="copyright-notice" class="border-t border-[color:var(--border-light)] dark:border-[color:var(--border-dark)] pt-4 mt-4 text-center"></div>
            </div>
            <button id="agree-btn" class="w-full p-3 mt-6 bg-[color:var(--accent-blue)] text-white rounded-lg font-semibold text-lg flex-shrink-0 hover:opacity-90 transition-opacity">Agree & Continue</button>
        </div>
    </div>
    
    <div class="ad-container adbox"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, addDoc, deleteDoc, updateDoc, query, onSnapshot, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Global Variables & Constants ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const firebaseConfig = { apiKey: "AIzaSyCOdmgGQqwZ6pSgSwvA15zjE_HTk16m_3k", authDomain: "dashboard-9c2e5.firebaseapp.com", projectId: "dashboard-9c2e5", storageBucket: "dashboard-9c2e5.appspot.com", messagingSenderId: "762310151203", appId: "1:762310151203:web:daf8974afa97d9457ab596" };
        const ADMIN_EMAIL = 'mdali82350@gmail.com';

        let app, auth, db;
        let allData = [], notifications = [];
        let state = { lang: localStorage.getItem('lang') || 'en', theme: localStorage.getItem('theme') || 'dark', isAdmin: false, page: 'subjects', subjectId: null, chapterId: null, highlightedTestId: null, searchTerm: '' };
        const translations = { en: { dashboard: "Dashboard", chapters: "Chapters", back: "Back" }, hi: { dashboard: "डैशबोर्ड", chapters: "अध्याय", back: "वापस" } };
        let unsubData, unsubNotifications;

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDynamicContent();
            applyTheme(state.theme, true);
            setupLottie();
            
            setTimeout(() => { 
                $('#splash-screen').style.opacity = '0'; 
                setTimeout(() => { 
                    $('#splash-screen').style.display = 'none'; 
                    checkTermsAgreement();
                }, 500); 
            }, 3000);
        });

        function checkTermsAgreement() {
            if (localStorage.getItem('hasAgreedToTerms') === 'true') { startApp(); } 
            else {
                $('#terms-modal').classList.remove('hidden');
                $('#agree-btn').addEventListener('click', () => {
                    localStorage.setItem('hasAgreedToTerms', 'true');
                    $('#terms-modal').classList.add('hidden');
                    startApp();
                });
            }
        }
        
        async function startApp() {
            $('#app').classList.remove('hidden');
            setTimeout(() => $('#app').style.opacity = '1', 50);
            
            loadAdScripts();
            $('#main-content').innerHTML = renderLoader();
            
            // Run ad blocker check after a short delay
            setTimeout(async () => { 
                if (await checkAdBlocker()) { 
                    $('#adblock-warning').classList.remove('hidden'); 
                } 
            }, 1500);

            initializeAppAndFirebase();
            updateLanguageUI();
            setupEventListeners();
            getHighlightedTestFromURL();
            setupDonationWidget();
            makeDraggable($('#donation-container'));
            setupPanelGestures($('#settings-panel'));
            setupPanelGestures($('#notifications-panel'));
        }

        function initializeAppAndFirebase() {
            try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                onAuthStateChanged(auth, user => { state.isAdmin = user && user.email === ADMIN_EMAIL; renderAdminPanel(); });
                setupRealtimeListeners();
            } catch (error) { console.error("Firebase Error:", error); showToast("Server connection failed.", 'error'); }
        }
        
        // --- Realtime Data & State ---
        function setupRealtimeListeners() {
            if (unsubData) unsubData();
            unsubData = onSnapshot(query(collection(db, 'subjects'), orderBy('timestamp', 'asc')), async (subjectSnapshot) => {
                const fetchedData = await Promise.all(subjectSnapshot.docs.map(async (subjectDoc) => {
                    const subject = { id: subjectDoc.id, ...subjectDoc.data(), chapters: [] };
                    const chaptersSnapshot = await getDocs(query(collection(db, 'subjects', subject.id, 'chapters'), orderBy('timestamp', 'asc')));
                    subject.chapters = await Promise.all(chaptersSnapshot.docs.map(async (chapterDoc) => {
                        const chapter = { id: chapterDoc.id, ...chapterDoc.data(), tests: [] };
                        const testsSnapshot = await getDocs(query(collection(db, 'subjects', subject.id, 'chapters', chapter.id, 'tests'), orderBy('timestamp', 'asc')));
                        chapter.tests = testsSnapshot.docs.map(testDoc => ({ id: testDoc.id, ...testDoc.data() }));
                        return chapter;
                    }));
                    return subject;
                }));
                allData = fetchedData;
                renderCurrentPage();
            });

            if (unsubNotifications) unsubNotifications();
            unsubNotifications = onSnapshot(query(collection(db, 'notifications'), orderBy('timestamp', 'desc')), (snapshot) => {
                notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.isAdmin && $('#admin-notifications-list')) $('#admin-notifications-list').innerHTML = renderAdminNotificationsList();
                const lastSeen = localStorage.getItem('lastSeenNotification') || 0;
                if (notifications.length > 0 && notifications[0].timestamp?.toMillis() > lastSeen) { $('#notification-badge').classList.remove('hidden'); }
            });
        }
        
        function renderCurrentPage() {
            let navigated = false;
            if (state.highlightedTestId) {
                for (const subject of allData) { for (const chapter of subject.chapters) { if (chapter.tests.some(t => t.id === state.highlightedTestId)) { navigateTo('tests', { subjectId: subject.id, chapterId: chapter.id }); navigated = true; break; } } if (navigated) break; }
            }
            if (!navigated) { navigateTo(state.page, { subjectId: state.subjectId, chapterId: state.chapterId }); }
            if (state.isAdmin) renderAdminPanel();
        }

        // --- UI & Theme Management ---
        function applyTheme(theme, isInitial = false) {
            state.theme = theme; localStorage.setItem('theme', theme);
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const themeToApply = theme === 'system' ? systemTheme : theme;
            document.documentElement.className = themeToApply;
            updateThemeUI();
            if (!isInitial) showToast(`Theme set to ${theme.charAt(0).toUpperCase() + theme.slice(1)}`);
        }
        
        function updateThemeUI() { $$('.theme-btn').forEach(btn => { const isSelected = btn.dataset.theme === state.theme; const isDark = document.documentElement.classList.contains('dark'); btn.classList.toggle('bg-white', isSelected && !isDark); btn.classList.toggle('dark:bg-gray-900', isSelected && isDark); btn.classList.toggle('text-gray-500', !isSelected); btn.classList.toggle('dark:text-gray-400', !isSelected); }); }
        function updateLanguageUI() { localStorage.setItem('lang', state.lang); $$('.lang-btn').forEach(btn => { const isSelected = btn.dataset.lang === state.lang; const isDark = document.documentElement.classList.contains('dark'); btn.classList.toggle('bg-white', isSelected && !isDark); btn.classList.toggle('dark:bg-gray-900', isSelected && isDark); btn.classList.toggle('text-gray-500', !isSelected); btn.classList.toggle('dark:text-gray-400', !isSelected); }); $('#back-button-text').textContent = translations[state.lang].back; }
        
        // --- Navigation & Rendering ---
        function navigateTo(page, context = {}) {
            state.page = page; Object.assign(state, context);
            
            if (state.searchTerm && page !== 'subjects') { state.searchTerm = ''; $('#search-input').value = ''; }
            if ($('#search-wrapper').classList.contains('is-active')) { $('#search-button').click(); }
            
            $('#main-content').innerHTML = renderLoader();
            
            $('#search-wrapper').style.display = (page === 'subjects') ? 'flex' : 'none';
            if (page === 'subjects') { $('#header-left-content').style.opacity = '1'; $('#back-button').classList.add('hidden'); $('#header-title').classList.remove('hidden'); $('#header-title').textContent = translations[state.lang].dashboard; } 
            else { $('#header-title').classList.add('hidden'); $('#back-button').classList.remove('hidden'); if (page === 'chapters') { $('#back-button-text').textContent = translations[state.lang].dashboard; } else if (page === 'tests') { const subject = allData.find(s => s.id === state.subjectId); $('#back-button-text').textContent = subject ? subject[`name_${state.lang}`] : translations[state.lang].chapters; } }
            setTimeout(() => { if (page === 'subjects') renderSubjects(); else if (page === 'chapters') renderChapters(state.subjectId); else if (page === 'tests') renderTests(state.subjectId, state.chapterId); }, 50);
        }

        function renderSubjects() {
            let filteredData = allData;
            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filteredData = allData.filter(s => s.name_en.toLowerCase().includes(term) || s.name_hi.toLowerCase().includes(term) || s.chapters.some(c => c.name_en.toLowerCase().includes(term) || c.name_hi.toLowerCase().includes(term) || c.tests.some(t => t.name.toLowerCase().includes(term))));
            }
            let content = (filteredData.length === 0) ? renderEmptyState("No subjects found.", state.searchTerm ? `Try a different search term.` : "New subjects will be added soon.") : `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">${filteredData.map(s => `<div class="ios-card group aspect-square flex flex-col items-center justify-center p-4 rounded-2xl text-center cursor-pointer shadow-sm hover:shadow-xl hover:-translate-y-1 subject-card" data-id="${s.id}"><img src="${s.logoUrl}" alt="${s[`name_${state.lang}`]}" class="w-16 h-16 object-cover rounded-xl mb-3 shadow-md group-hover:scale-110 transition-transform duration-300" onerror="this.src='https://placehold.co/100x100/0a84ff/ffffff?text=??'"><p class="font-semibold text-lg mt-2">${s[`name_${state.lang}`]}</p></div>`).join('')}</div>`;
            $('#main-content').innerHTML = `<div class="content-transition">${content}</div>`;
        }
        function renderChapters(subjectId) {
            const subject = allData.find(s => s.id === subjectId);
            if (!subject) { $('#main-content').innerHTML = renderEmptyState("Subject Not Found", "This subject may have been removed."); return; }
            let content = `<h2 class="text-3xl font-bold mb-6">${subject[`name_${state.lang}`]}</h2>`;
            content += (subject.chapters.length === 0) ? renderEmptyState("No chapters in this subject.", "New chapters will be added soon.") : `<div class="space-y-3">${subject.chapters.map(c => `<div class="ios-card p-4 rounded-xl flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition chapter-card" data-subject-id="${subjectId}" data-chapter-id="${c.id}"><span class="font-semibold text-lg">${c[`name_${state.lang}`]}</span><svg class="w-6 h-6 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" /></svg></div>`).join('')}</div>`;
            $('#main-content').innerHTML = `<div class="content-transition">${content}</div>`;
        }
        function renderTests(subjectId, chapterId) {
            const subject = allData.find(s => s.id === subjectId);
            const chapter = subject?.chapters.find(c => c.id === chapterId);
            if (!chapter) { $('#main-content').innerHTML = renderEmptyState("Chapter Not Found", "This chapter may have been removed."); return; }
            let content = `<h2 class="text-3xl font-bold mb-6">${chapter[`name_${state.lang}`]}</h2>`;
            const attemptedTests = JSON.parse(localStorage.getItem('attemptedTests')) || [];
            content += (chapter.tests.length === 0) ? renderEmptyState("No tests available.", "Check back later for new tests.") : `<div class="space-y-4">${chapter.tests.map(test => { const isAttempted = attemptedTests.includes(test.id); return `<div class="ios-card p-4 rounded-xl transition ${test.id === state.highlightedTestId ? 'blinking-row' : ''}" id="test-${test.id}"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl">${test.name}</h3><button aria-label="Share test link" class="share-btn p-2 -mt-2 -mr-2 rounded-full text-secondary hover:text-[color:var(--accent-blue)] transition-colors" data-link="${window.location.origin}${window.location.pathname}?testId=${test.id}"><svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg></button></div><div class="text-sm text-secondary flex items-center space-x-4 mb-3 font-medium"><span>${test.questions} Qs</span><span>&bull;</span><span>${test.time} Mins</span></div>${test.description ? `<p class="text-base mb-4">${test.description}</p>` : ''}<a href="${test.redirectLink}" target="_blank" class="start-test-btn w-full text-center block p-3 rounded-lg font-semibold text-lg transition text-white hover:opacity-90" data-testid="${test.id}" style="background-color: ${isAttempted ? 'var(--accent-yellow)' : 'var(--accent-blue)'};">${isAttempted ? 'Re-attempt' : 'Start Test'}</a></div>`; }).join('')}</div>`;
            $('#main-content').innerHTML = `<div class="content-transition">${content}</div>`;
            if (state.highlightedTestId) { const el = $(`#test-${state.highlightedTestId}`); if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200); }
        }
        
        // --- Event Listeners ---
        function setupEventListeners() {
            $('#main-content').addEventListener('click', e => { const subjectCard = e.target.closest('.subject-card'); if (subjectCard) { navigateTo('chapters', { subjectId: subjectCard.dataset.id }); return; } const chapterCard = e.target.closest('.chapter-card'); if (chapterCard) { navigateTo('tests', { subjectId: chapterCard.dataset.subjectId, chapterId: chapterCard.dataset.chapterId }); return; } const shareBtn = e.target.closest('.share-btn'); if (shareBtn) { copyTextToClipboard(shareBtn.dataset.link).then(() => showToast('Test link copied!')).catch(() => showToast('Failed to copy link.', 'error')); return; } const startTestBtn = e.target.closest('.start-test-btn'); if (startTestBtn) { const testId = startTestBtn.dataset.testid; let attempted = JSON.parse(localStorage.getItem('attemptedTests')) || []; if (!attempted.includes(testId)) { attempted.push(testId); localStorage.setItem('attemptedTests', JSON.stringify(attempted)); } startTestBtn.textContent = 'Re-attempt'; startTestBtn.style.backgroundColor = 'var(--accent-yellow)'; return; } });
            $('#back-button').addEventListener('click', () => { if (state.page === 'tests') navigateTo('chapters', { subjectId: state.subjectId }); else if (state.page === 'chapters') navigateTo('subjects'); });
            $('#settings-button').addEventListener('click', () => togglePanel('settings-panel', true));
            $('#search-button').addEventListener('click', () => { const wrapper = $('#search-wrapper'); const input = $('#search-input'); const headerContent = $('#header-left-content'); wrapper.classList.toggle('is-active'); if (wrapper.classList.contains('is-active')) { headerContent.style.opacity = '0'; headerContent.style.pointerEvents = 'none'; input.focus(); } else { headerContent.style.opacity = '1'; headerContent.style.pointerEvents = 'auto'; input.blur(); if (input.value) { input.value = ''; state.searchTerm = ''; renderSubjects(); } } });
            $('#search-input').addEventListener('input', e => { state.searchTerm = e.target.value; renderSubjects(); });
            $('#panel-overlay').addEventListener('click', () => { $$('[id$="-panel"], [id$="-modal"], #admin-panel-container').forEach(el => togglePanel(el.id, false)); });
            $$('.theme-btn').forEach(btn => btn.addEventListener('click', e => applyTheme(e.currentTarget.dataset.theme)));
            $$('.lang-btn').forEach(btn => btn.addEventListener('click', e => { state.lang = e.target.dataset.lang; updateLanguageUI(); renderCurrentPage(); }));
            $('#admin-code-input').addEventListener('input', e => { if (e.target.value.toUpperCase() === 'A7NOW') { togglePanel('settings-panel', false); togglePanel('admin-panel-container', true); e.target.value = ''; } });
            $('#notifications-button').addEventListener('click', () => { renderNotificationsPanel(); togglePanel('notifications-panel', true); $('#notification-badge').classList.add('hidden'); if (notifications.length > 0 && notifications[0].timestamp) localStorage.setItem('lastSeenNotification', notifications[0].timestamp.toMillis()); });
            $('#confirm-cancel-btn').addEventListener('click', () => togglePanel('confirm-modal', false));
            $('#confirm-action-btn').addEventListener('click', performAction);
            $('#clear-attempts-btn').addEventListener('click', () => openConfirmModal('clearAttempts', 'Clear All Attempts?', 'This will reset all quizzes to "Start Test".', 'Clear All'));
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (state.theme === 'system') applyTheme('system'); });
        }

        // --- Utilities & Helpers ---
        function loadAdScript(placeholderId, options) {
            const placeholder = $(`#${placeholderId}`);
            if (!placeholder) return;
            placeholder.innerHTML = ''; // Clear previous content
            const optionsScript = document.createElement('script');
            optionsScript.type = 'text/javascript';
            optionsScript.innerHTML = `atOptions = ${JSON.stringify(options.atOptions)};`;
            const adScript = document.createElement('script');
            adScript.type = 'text/javascript';
            adScript.src = options.src;
            adScript.async = true;
            placeholder.appendChild(optionsScript);
            placeholder.appendChild(adScript);
        }
        function loadAdScripts() {
            loadAdScript('ad-placeholder-top', { atOptions: { 'key': 'ade27afee177c088e865bebbc4dca698', 'format': 'iframe', 'height': 50, 'width': 320, 'params': {} }, src: '//www.highperformanceformat.com/ade27afee177c088e865bebbc4dca698/invoke.js' });
            loadAdScript('ad-placeholder-bottom', { atOptions: { 'key': 'cac12d1f7e9fc0e9d86da17a222bee6c', 'format': 'iframe', 'height': 250, 'width': 300, 'params': {} }, src: '//www.highperformanceformat.com/cac12d1f7e9fc0e9d86da17a222bee6c/invoke.js' });
        }
        function togglePanel(panelId, show) { const panel = $(`#${panelId}`); if (!panel) return; const overlay = $('#panel-overlay'); if (show) { overlay.classList.remove('hidden'); panel.classList.remove('hidden'); setTimeout(() => { overlay.style.opacity = '1'; panel.classList.add('active', 'opacity-100'); }, 10); } else { overlay.style.opacity = '0'; panel.classList.remove('active', 'opacity-100'); setTimeout(() => { overlay.classList.add('hidden'); panel.classList.add('hidden'); }, 300); } }
        function showToast(message, type = 'success') { const toast = $('#toast'); $('#toast-message').textContent = message; toast.className = `fixed bottom-[-100px] left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 backdrop-blur-sm z-[100] ${type === 'error' ? 'bg-red-600 text-white' : 'bg-gray-900/80 dark:bg-gray-200/80 text-white dark:text-black'}`; toast.style.bottom = '5rem'; setTimeout(() => { toast.style.bottom = '-100px'; }, 3000); }
        function getHighlightedTestFromURL() { const urlParams = new URLSearchParams(window.location.search); state.highlightedTestId = urlParams.get('testId'); }
        function renderLoader() { return `<div class="flex justify-center items-center py-20"><div class="flex space-x-2"><div class="w-3 h-3 bg-[color:var(--accent-blue)] rounded-full animate-bounce" style="animation-delay: -0.3s;"></div><div class="w-3 h-3 bg-[color:var(--accent-blue)] rounded-full animate-bounce" style="animation-delay: -0.15s;"></div><div class="w-3 h-3 bg-[color:var(--accent-blue)] rounded-full animate-bounce"></div></div></div>`; }
        function copyTextToClipboard(text) { return new Promise((resolve, reject) => { const ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy') ? resolve() : reject(); } catch (err) { reject(err); } finally { document.body.removeChild(ta); } }); }
        function renderEmptyState(title, message) { return `<div class="text-center py-16 px-4"><svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg><h3 class="mt-4 text-lg font-semibold">${title}</h3><p class="mt-1 text-base text-secondary">${message}</p></div>`; }
        function setupDonationWidget() { const messages = ["Enjoying the app?", "Support our work"]; let i = 0; const msgEl = $('#donation-message'); if (!msgEl) return; msgEl.textContent = messages[i]; setInterval(() => { i = (i + 1) % messages.length; msgEl.style.opacity = '0'; setTimeout(() => { msgEl.textContent = messages[i]; msgEl.style.opacity = '1'; }, 400); }, 4000); }
        function setupLottie() { try { lottie.loadAnimation({ container: $('#lottie-animation'), renderer: 'svg', loop: true, autoplay: true, path: 'h.json' }); } catch(e) { console.error("Lottie failed to load.")} }
        function updateDynamicContent() { const year = new Date().getFullYear(); $('#effective-date').textContent = `Effective Date: 30 August ${year}`; $('#copyright-notice').innerHTML = `<p class="font-bold">Copyright &copy; ${year} – Quizeyi</p><p class="text-xs">All rights reserved. Intellectual property of Quizeyi.</p>`; }
        async function checkAdBlocker() { const bait = document.createElement('div'); bait.className = 'pub_300x250 pub_300x250m pub_728x90 text-ad text-ads text-ad-links ad-text ad-banner'; bait.style.cssText = 'width: 1px !important; height: 1px !important; position: absolute !important; left: -9999px !important; top: -9999px !important;'; document.body.appendChild(bait); await new Promise(resolve => setTimeout(resolve, 100)); let isBlocked = false; if (bait.offsetParent === null || bait.offsetHeight === 0 || window.getComputedStyle(bait).display === 'none') { isBlocked = true; } try { await fetch(new Request("https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js", { method: 'HEAD', mode: 'no-cors' })); } catch (e) { isBlocked = true; } bait.remove(); return isBlocked; }
        function makeDraggable(element) { let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; element.onmousedown = dragMouseDown; element.ontouchstart = dragMouseDown; function dragMouseDown(e) { if (e.target.closest('#donation-link')) return; e.preventDefault(); if (e.type === "touchstart") { pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; } else { pos3 = e.clientX; pos4 = e.clientY; } document.onmouseup = closeDragElement; document.ontouchend = closeDragElement; document.onmousemove = elementDrag; document.ontouchmove = elementDrag; } function elementDrag(e) { e.preventDefault(); if (e.type === "touchmove") { pos1 = pos3 - e.touches[0].clientX; pos2 = pos4 - e.touches[0].clientY; pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; } else { pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; } element.style.top = (element.offsetTop - pos2) + "px"; element.style.left = (element.offsetLeft - pos1) + "px"; } function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; } }
        function setupPanelGestures(panel) { let startY, currentY; panel.addEventListener('touchstart', e => { startY = e.touches[0].clientY; currentY = startY; }, { passive: true }); panel.addEventListener('touchmove', e => { if (panel.scrollTop === 0) { currentY = e.touches[0].clientY; const diff = currentY - startY; if (diff > 0) { e.preventDefault(); panel.style.transform = `translateY(${diff}px)`; } } }, { passive: false }); panel.addEventListener('touchend', () => { const diff = currentY - startY; if (diff > 100) { togglePanel(panel.id, false); } panel.style.transform = ''; }); }

        // --- Admin & CRUD ---
        function openConfirmModal(action, title, text, buttonText) { const confirmBtn = $('#confirm-action-btn'); $('#confirm-modal-title').textContent = title; $('#confirm-modal-text').textContent = text; confirmBtn.textContent = buttonText; Object.keys(confirmBtn.dataset).forEach(key => delete confirmBtn.dataset[key]); confirmBtn.dataset.action = action; togglePanel('confirm-modal', true); }
        async function deleteSubjectAndSubcollections(subjectId) { const batch = writeBatch(db); const subjectRef = doc(db, 'subjects', subjectId); const chaptersSnapshot = await getDocs(collection(subjectRef, 'chapters')); for (const chapterDoc of chaptersSnapshot.docs) { const chapterRef = doc(subjectRef, 'chapters', chapterDoc.id); const testsSnapshot = await getDocs(collection(chapterRef, 'tests')); testsSnapshot.forEach(testDoc => batch.delete(testDoc.ref)); batch.delete(chapterRef); } batch.delete(subjectRef); await batch.commit(); }
        async function performAction(e) { const { action, type, id, subjectId, chapterId } = e.currentTarget.dataset; let docRef; try { if (action === 'delete') { if (type === 'subject') { await deleteSubjectAndSubcollections(id); } else { if (type === 'chapter') docRef = doc(db, 'subjects', subjectId, 'chapters', id); else if (type === 'test') docRef = doc(db, 'subjects', subjectId, 'chapters', chapterId, 'tests', id); else if (type === 'notification') docRef = doc(db, 'notifications', id); if (docRef) await deleteDoc(docRef); } showToast(`${type} deleted.`); } else if (action === 'clearAttempts') { localStorage.removeItem('attemptedTests'); showToast('Quiz attempts cleared!'); renderCurrentPage(); } } catch (error) { showToast(`Error performing action.`, 'error'); console.error(error); } finally { togglePanel('confirm-modal', false); } }
        function renderAdminPanel() { const container = $('#admin-panel-container'); if (!container) return; if (!state.isAdmin) { container.innerHTML = `<div class="w-full max-w-sm p-8 rounded-2xl shadow-lg ios-card"><h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2><form id="admin-login-form" class="space-y-4"><input type="email" id="admin-email" placeholder="Email" required class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-900 focus:ring-2 focus:ring-[color:var(--accent-blue)] border-0 text-lg"><input type="password" id="admin-password" placeholder="Password" required class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-900 focus:ring-2 focus:ring-[color:var(--accent-blue)] border-0 text-lg"><button type="submit" class="w-full p-3 bg-[color:var(--accent-blue)] text-white rounded-lg font-semibold text-lg">Login</button></form></div>`; container.addEventListener('submit', handleAdminLogin); } else { container.innerHTML = `<div class="h-full w-full bg-gray-100 dark:bg-black overflow-y-auto"><div class="sticky top-0 z-10 ios-header p-4"><div class="max-w-4xl mx-auto flex justify-between items-center"><h2 class="text-3xl font-bold">Admin Panel</h2><div><button id="admin-close-btn" class="p-2 text-lg text-[color:var(--accent-blue)] font-medium">Done</button><button id="logout-button" class="ml-2 px-3 py-2 bg-[color:var(--accent-red)] text-white rounded-lg font-semibold">Logout</button></div></div></div><div class="max-w-4xl mx-auto p-4 space-y-6"><div class="ios-card p-4 rounded-xl"><div class="flex justify-between items-center mb-3"><h3 class="text-xl font-bold">Notifications</h3><button id="add-notification-btn" class="p-2 bg-[color:var(--accent-blue)] text-white rounded-lg font-semibold text-sm">Send New</button></div><div id="admin-notifications-list">${renderAdminNotificationsList()}</div></div><div class="ios-card p-4 rounded-xl"><div class="flex justify-between items-center mb-3"><h3 class="text-xl font-bold">Subjects</h3><button id="add-subject-btn" class="p-2 bg-[color:var(--accent-blue)] text-white rounded-lg font-semibold text-sm">Add Subject</button></div><div id="admin-subjects-list">${renderAdminSubjectsList()}</div></div></div></div>`; container.addEventListener('click', e => { if (e.target.id === 'admin-close-btn') togglePanel('admin-panel-container', false); if (e.target.id === 'logout-button') handleLogout(); if (e.target.id === 'add-subject-btn') openFormModal('subject'); if (e.target.id === 'add-notification-btn') openFormModal('notification'); handleAdminListClick(e); }); } }
        async function handleAdminLogin(e) { e.preventDefault(); if (e.target.id !== 'admin-login-form') return; if (e.target.elements['admin-email'].value !== ADMIN_EMAIL) return showToast('Invalid admin email.', 'error'); try { await signInWithEmailAndPassword(auth, e.target.elements['admin-email'].value, e.target.elements['admin-password'].value); showToast('Admin login successful!'); } catch (error) { showToast('Login failed. Check credentials.', 'error'); } }
        function renderAdminSubjectsList() { return allData.map(s => `<div class="bg-gray-50 dark:bg-gray-900/50 rounded-xl p-3 mb-2 border border-[color:var(--border-light)] dark:border-[color:var(--border-dark)]"><div class="flex items-center justify-between flex-wrap gap-2"><span class="font-semibold">${s['name_en']}</span><div class="flex items-center gap-2 flex-shrink-0"><button class="edit-btn text-sm p-1 text-[color:var(--accent-blue)]" data-type="subject" data-id="${s.id}">Edit</button><button class="delete-btn text-sm p-1 text-[color:var(--accent-red)]" data-type="subject" data-id="${s.id}">Delete</button><button class="add-chapter-btn text-sm px-2 py-1 bg-[color:var(--accent-green)] text-white rounded-md" data-subject-id="${s.id}">+ Chapter</button></div></div><div class="pl-4 mt-2 space-y-1">${s.chapters.map(c => `<div class="bg-gray-100 dark:bg-gray-800 p-2 rounded-lg"><div class="flex items-center justify-between flex-wrap gap-2"><span>${c['name_en']}</span><div class="flex items-center gap-2 flex-shrink-0"><button class="edit-btn text-xs p-1 text-[color:var(--accent-blue)]" data-type="chapter" data-subject-id="${s.id}" data-id="${c.id}">Edit</button><button class="delete-btn text-xs p-1 text-[color:var(--accent-red)]" data-type="chapter" data-subject-id="${s.id}" data-id="${c.id}">Delete</button><button class="add-test-btn text-xs px-2 py-1 bg-[color:var(--accent-blue)] text-white rounded-md" data-subject-id="${s.id}" data-chapter-id="${c.id}">+ Test</button></div></div><div class="pl-4 mt-1 space-y-1">${c.tests.map(t => `<div class="flex items-center justify-between text-xs py-1 border-b border-gray-200 dark:border-gray-700 last:border-0"><span>${t.name}</span><div class="flex items-center gap-2 flex-shrink-0"><button class="edit-btn p-1 text-[color:var(--accent-blue)]" data-type="test" data-subject-id="${s.id}" data-chapter-id="${c.id}" data-id="${t.id}">Edit</button><button class="delete-btn p-1 text-[color:var(--accent-red)]" data-type="test" data-subject-id="${s.id}" data-chapter-id="${c.id}" data-id="${t.id}">Delete</button></div></div>`).join('')}</div></div>`).join('')}</div></div>`).join(''); }
        function renderAdminNotificationsList() { if (notifications.length === 0) return `<p class="text-sm text-center text-secondary py-4">No notifications sent yet.</p>`; return `<div class="space-y-2">${notifications.map(n => `<div class="bg-gray-100 dark:bg-gray-800 p-2 rounded-lg flex items-center justify-between text-sm"><p class="truncate pr-4">${n.message}</p><div class="flex items-center gap-2 flex-shrink-0"><button class="edit-btn text-xs p-1 text-[color:var(--accent-blue)]" data-type="notification" data-id="${n.id}">Edit</button><button class="delete-btn text-xs p-1 text-[color:var(--accent-red)]" data-type="notification" data-id="${n.id}">Delete</button></div></div>`).join('')}</div>`; }
        function handleAdminListClick(e) { const btn = e.target.closest('button'); if (!btn) return; const { type, id, subjectId, chapterId } = btn.dataset; if (btn.classList.contains('add-chapter-btn')) openFormModal('chapter', null, { subjectId }); else if (btn.classList.contains('add-test-btn')) openFormModal('test', null, { subjectId, chapterId }); else if (btn.classList.contains('edit-btn')) openFormModal(type, id, { subjectId, chapterId }); else if (btn.classList.contains('delete-btn')) handleDelete(type, id, subjectId, chapterId); }
        async function handleLogout() { await signOut(auth); showToast('Logged out.'); }
        function handleDelete(type, id, subjectId, chapterId) { openConfirmModal('delete', `Delete ${type}?`, 'This action cannot be undone.', 'Delete'); const confirmBtn = $('#confirm-action-btn'); Object.assign(confirmBtn.dataset, { type, id, subjectId: subjectId || '', chapterId: chapterId || '' }); }
        function openFormModal(type, id = null, context = {}) { const form = $('#modal-form'); form.reset(); Object.assign(form.dataset, { type, id: id || '', context: JSON.stringify(context) }); let currentData = {}; if (id) { if (type === 'subject') currentData = allData.find(s => s.id === id); else if (type === 'chapter') currentData = allData.find(s => s.id === context.subjectId)?.chapters.find(c => c.id === id); else if (type === 'test') currentData = allData.find(s => s.id === context.subjectId)?.chapters.find(c => c.id === context.chapterId)?.tests.find(t => t.id === id); else if (type === 'notification') currentData = notifications.find(n => n.id === id); } const inputClass = "w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-900 focus:ring-2 focus:ring-[color:var(--accent-blue)] border-0"; let fieldsHtml = ''; if (type === 'subject') { fieldsHtml = `<input name="name_en" required placeholder="English Name" class="${inputClass}" value="${currentData.name_en || ''}"><input name="name_hi" required placeholder="Hindi Name" class="${inputClass}" value="${currentData.name_hi || ''}"><input type="url" name="logoUrl" required placeholder="Logo URL" class="${inputClass}" value="${currentData.logoUrl || ''}">`; } else if (type === 'chapter') { fieldsHtml = `<input name="name_en" required placeholder="English Name" class="${inputClass}" value="${currentData.name_en || ''}"><input name="name_hi" required placeholder="Hindi Name" class="${inputClass}" value="${currentData.name_hi || ''}">`; } else if (type === 'test') { fieldsHtml = `<input name="name" required placeholder="Test Name" class="${inputClass}" value="${currentData.name || ''}"><input type="number" name="questions" required placeholder="Total Qs" class="${inputClass}" value="${currentData.questions || ''}"><input type="number" name="time" required placeholder="Time (Mins)" class="${inputClass}" value="${currentData.time || ''}"><input type="url" name="redirectLink" required placeholder="Redirect Link" class="${inputClass}" value="${currentData.redirectLink || ''}"><textarea name="description" placeholder="Description (Optional)" class="${inputClass}">${currentData.description || ''}</textarea>`; } else if (type === 'notification') { fieldsHtml = `<input name="message" required placeholder="Message" class="${inputClass}" value="${currentData.message || ''}"><input type="url" name="link" placeholder="Optional Link" class="${inputClass}" value="${currentData.link || ''}">`; } fieldsHtml += `<button type="submit" class="w-full p-3 bg-[color:var(--accent-blue)] text-white rounded-lg font-semibold">Save</button>`; $('#modal-title').textContent = `${id ? 'Edit' : 'Add'} ${type.charAt(0).toUpperCase() + type.slice(1)}`; form.innerHTML = fieldsHtml; togglePanel('form-modal', true); $('#close-modal-btn').onclick = () => togglePanel('form-modal', false); form.onsubmit = handleFormSubmit; }
        async function handleFormSubmit(e) { e.preventDefault(); const { type, id, context } = e.target.dataset; const data = Object.fromEntries(new FormData(e.target).entries()); const parsedContext = JSON.parse(context); let collectionRef; if (type === 'subject') collectionRef = collection(db, 'subjects'); else if (type === 'chapter') collectionRef = collection(db, 'subjects', parsedContext.subjectId, 'chapters'); else if (type === 'test') collectionRef = collection(db, 'subjects', parsedContext.subjectId, 'chapters', parsedContext.chapterId, 'tests'); else if (type === 'notification') collectionRef = collection(db, 'notifications'); if (!id) data.timestamp = serverTimestamp(); try { if (id) { await updateDoc(doc(collectionRef, id), data); } else { await addDoc(collectionRef, data); } showToast(`${type} saved.`); togglePanel('form-modal', false); } catch (error) { showToast(`Error saving ${type}.`, 'error'); console.error(error); } }
        function renderNotificationsPanel() { const list = $('#notifications-list'); if (notifications.length === 0) { list.innerHTML = renderEmptyState("No notifications yet.", "We'll let you know when there's news."); return; } list.innerHTML = notifications.map(n => `<div class="ios-card rounded-xl p-4"><p class="font-semibold mb-1">${n.message}</p><p class="text-sm text-secondary">${n.timestamp?.toDate().toLocaleString() || ''}</p>${n.link ? `<a href="${n.link}" target="_blank" class="text-[color:var(--accent-blue)] font-medium mt-2 inline-block">View Link</a>` : ''}</div>`).join(''); }

    </script>



<script type="text/javascript"> atOptions = { 'key' : 'cac12d1f7e9fc0e9d86da17a222bee6c', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} }; </script> <script type="text/javascript" src="//www.highperformanceformat.com/cac12d1f7e9fc0e9d86da17a222bee6c/invoke.js"></script>



</body>
</html>

